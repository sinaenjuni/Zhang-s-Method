import cv2
import numpy as np
import numpy.linalg as la
import files
from homography import compute_homography
from intrinsic import compute_intrinsic
import matplotlib.pyplot as plt


def get_image(path):
    return cv2.imread(path, cv2.IMREAD_COLOR)

def get_image_point(img, col, row, use_subpix=True):
    gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    criteria = (cv2.TERM_CRITERIA_EPS | cv2.TERM_CRITERIA_MAX_ITER, 30, 0.001)
    gray_img = cv2.equalizeHist(gray_img)

    ret, corners = cv2.findChessboardCorners(gray_img, (col, row), None)

    corners = corners.reshape(-1, 2)
    if use_subpix:
        corners = cv2.cornerSubPix(gray_img,corners, (col, row), (-1,-1), criteria=criteria)
    return ret, corners

# def apply_homography(H, point):
#     point_homo = np.hstack((point, 1)) # change homogeneous coordinates
#     point_homo = H@point_homo # projection
#     point_homo /= point_homo[-1] # normalize
#     return point_homo[:2] # change non-homogeneous coordinates

def apply_homography(H:np.array, point_homo:np.array)->np.array:
    homo_point = np.hstack((point_homo, np.ones((point_homo.shape[0], 1))))
    cvt_homo_point = (H@homo_point.T).T
    cvt_point = cvt_homo_point / cvt_homo_point[..., [-1]]
    return cvt_point[:,:2]

def get_world_point(col, row, square_size):
    y, x = np.meshgrid(np.arange(col), np.arange(row))
    x, y = x.reshape(-1, 1), y.reshape(-1, 1)
    z = np.zeros_like(x)
    ret = np.hstack((x, y, z)) * square_size
    return ret.astype(np.float32)


if __name__ == "__main__":
    np.set_printoptions(suppress=True, linewidth=1000)
    TEST = True
    VIS = True

    col, row = 7, 9 # checkboard patterns are 9 row and 7 col.
    # col, row = 9, 7 # checkboard patterns are 9 row and 7 col.
    square_size = 20 # 20mm
    world_point = get_world_point(col, row, square_size)

    # test data
    if TEST:

        d1 = np.array([ 1377.97924804688, 534.684753417969, 1354.44262695312, 656.510986328125,
            1329.71301269531, 784.600280761719, 1303.39318847656, 919.229064941406,
            1274.77380371094, 1061.18872070312, 1243.77941894531, 1212.0869140625,
            1209.80419921875, 1372.04516601562, 1535.26879882812, 538.185180664062,
            1516.09362792969, 660.969299316406, 1495.80725097656, 788.76416015625,
            1474.16564941406, 923.042114257812, 1451.33837890625, 1065.38000488281,
            1425.65441894531, 1216.83044433594, 1398.4541015625, 1379.23681640625,
            1691.810546875, 543.30078125, 1676.70874023438, 666.613342285156,
            1660.78393554688, 795.186157226562, 1644.21813964844, 930.233337402344,
            1625.92626953125, 1072.63098144531, 1605.95678710938, 1223.74353027344,
            1584.41662597656, 1385.83923339844, 1849.85827636719, 549.59130859375,
            1838.61315917969, 673.190856933594, 1826.94677734375, 802.118408203125,
            1814.56811523438, 937.274230957031, 1801.54138183594, 1080.00073242188,
            1787.28039550781, 1231.25024414062, 1771.74084472656, 1392.56079101562,
            2006.705078125, 556.112121582031, 1999.1865234375, 679.938537597656,
            1991.34973144531, 809.197204589844, 1983.75842285156, 944.544311523438,
            1975.28820800781, 1087.63427734375, 1966.53918457031, 1239.2841796875,
            1957.04736328125, 1401.41442871094, 2165.60571289062, 563.059509277344,
            2161.91284179688, 686.846374511719, 2158.13452148438, 816.076477050781,
            2154.41284179688, 952.265502929688, 2151.35791015625, 1095.91394042969,
            2147.73413085938, 1248.93505859375, 2144.28857421875, 1413.02600097656,
            2324.37255859375, 570.454040527344, 2324.8818359375, 694.362548828125,
            2325.39624023438, 824.424438476562, 2326.7509765625, 961.021667480469,
            2328.25317382812, 1105.72241210938, 2330.3291015625, 1259.70056152344,
            2332.7744140625, 1424.87438964844, 2484.76611328125, 578.297668457031,
            2489.94995117188, 701.921691894531, 2495.26928710938, 832.097961425781,
            2501.11645507812, 969.2998046875, 2508.15551757812, 1114.90869140625,
            2515.96069335938, 1270.10498046875, 2524.56201171875, 1436.12817382812,
            2645.2470703125, 587.164978027344, 2655.05346679688, 710.604919433594,
            2665.70068359375, 840.374816894531, 2676.69873046875, 978.646545410156,
            2688.75073242188, 1125.08508300781, 2701.8701171875, 1282.08996582031,
            2716.03125, 1448.91418457031])

        d2 = np.array([ 1706.0166015625, 923.782592773438, 1713.41174316406, 1081.9270019531,
            1720.3408203125, 1237.87390136719, 1727.12780761719, 1393.0222167968,
            1733.30004882812, 1548.5201416015, 1739.2001953125, 1704.1982421875,
            1745.34643554688, 1860.7524414062, 1865.4736328125, 918.160278320312,
            1871.91662597656, 1075.5570068359, 1878.25537109375, 1230.8319091796,
            1884.20678710938, 1385.3148193359, 1890.63720703125, 1540.092773437,
            1896.40197753906, 1695.0487060546, 1902.41247558594, 1849.9327392578,
            2021.87414550781, 912.78228759765, 2027.30358886719, 1069.3983154296,
            2032.84045410156, 1223.9702148437, 2038.80004882812, 1377.5964355468,
            2044.39099121094, 1531.5980224609, 2050.2197265625, 1685.85327148438,
            2056.16748046875, 1840.1909179687, 2178.2392578125, 906.860717773438,
            2182.9755859375, 1062.97155761719, 2187.93676757812, 1216.9748535156,
            2193.01049804688, 1370.0960693359, 2198.92895507812, 1523.2761230468,
            2204.7392578125, 1676.95300292969, 2210.79541015625, 1831.118164062,
            2332.46557617188, 900.33874511718, 2336.365234375, 1056.14245605469,
            2340.53515625, 1209.80700683594, 2345.90478515625, 1362.5875244140,
            2351.02172851562, 1515.4720458984, 2356.7822265625, 1668.40356445312,
            2362.38671875, 1821.59814453125, 2487.72021484375, 893.86901855468,
            2490.759765625, 1049.34033203125, 2494.45874023438, 1202.8500976562,
            2498.68701171875, 1355.3944091796, 2503.93041992188, 1507.8239746093,
            2508.7666015625, 1659.86267089844, 2513.19018554688, 1811.1871337890,
            2640.96166992188, 886.85198974609, 2643.70678710938, 1042.2215576171,
            2646.75952148438, 1195.6320800781, 2650.89208984375, 1347.8054199218,
            2654.90576171875, 1499.6817626953, 2659.02612304688, 1650.8621826171,
            2662.63818359375, 1800.9556884765, 2793.69018554688, 880.15789794921,
            2796.09057617188, 1034.909179687, 2798.90625, 1188.01135253906,
            2802.1142578125, 1339.89294433594, 2805.61328125, 1491.17504882812,
            2808.42114257812, 1641.5983886718, 2811.13549804688, 1790.8089599609,
            2943.07080078125, 873.99505615234, 2945.62377929688, 1028.0393066406,
            2948.18115234375, 1180.7603759765, 2950.5947265625, 1331.94384765625,
            2952.62329101562, 1482.543945312, 2954.2548828125, 1631.60266113281,
            2955.80517578125, 1779.87634277344])

        d3 = np.array([ 1547.76354980469, 705.10113525390, 1521.96862792969, 816.04943847656,
            1494.28137207031, 933.73376464843, 1464.71081542969, 1059.0620117187,
            1431.87670898438, 1193.5163574218, 1395.76489257812, 1338.5477294921,
            1355.91040039062, 1495.0095214843, 1704.73413085938, 702.60833740234,
            1684.033203125, 814.231628417969, 1661.87890625, 931.738037109375,
            1637.89892578125, 1057, 1612.16931152344, 1191.7973632812,
            1583.32153320312, 1337.9158935546, 1552.32202148438, 1497.7229003906,
            1861.59143066406, 701.29968261718, 1845.82983398438, 813.54772949218,
            1828.98461914062, 932.13269042968, 1811.29516601562, 1058.4553222656,
            1791.55029296875, 1194.0964355468, 1770.07849121094, 1340.3375244140,
            1746.65380859375, 1500.29101562, 2021.25854492188, 701.16418457031,
            2010.35852050781, 813.97094726562, 1999.03857421875, 933.14044189453,
            1986.77465820312, 1060.2551269531, 1974.13488769531, 1196.5208740234,
            1959.82470703125, 1343.553710937, 1944.48559570312, 1503.0572509765,
            2181.30395507812, 701.55798339843, 2175.35205078125, 814.76538085937,
            2169.22705078125, 934.7690429687, 2163.353515625, 1062.38647460938,
            2156.73510742188, 1199.6343994140, 2149.9560546875, 1347.62805175781,
            2142.78100585938, 1509.0893554687, 2345.0830078125, 702.461120605469,
            2344.2529296875, 816.179504394531, 2343.75830078125, 936.28228759765,
            2343.29736328125, 1065.3347167968, 2343.88818359375, 1203.6840820312,
            2344.49975585938, 1353.9725341796, 2345.75830078125, 1518.5023193359,
            2510.18725585938, 704.46490478515, 2515.12158203125, 818.30059814453,
            2520.58813476562, 939.89624023437, 2527.26098632812, 1069.7148437,
            2534.56884765625, 1209.8209228515, 2543.02490234375, 1361.7514648437,
            2552.4296875, 1528.14831542969, 2678.08374023438, 707.16247558593,
            2689.333984375, 820.950622558594, 2701.40551757812, 942.93725585937,
            2714.6962890625, 1073.75415039062, 2729.41333007812, 1215.187,
            2745.759765625, 1369.11486816406, 2763.41845703125, 1536.3085937,
            2846.48364257812, 711.31701660156, 2864.0947265625, 825.188598632812,
            2883.05419921875, 946.94018554687, 2903.16381835938, 1079.1989746093,
            2924.90966796875, 1221.9992675781, 2948.38842773438, 1377.4783935546,
            2973.6826171875, 1546.00329589844])

        d4 = np.array([ 1114.0703125, 641.006164550781, 1114.98461914062, 818.081420898438,
            1115.88916015625, 993.27392578125, 1116.51220703125, 1166.89318847656,
            1116.17053222656, 1340.140625, 1115.73913574219, 1512.63818359375,
            1114.60632324219, 1685.041015625, 1280.23156738281, 641.906921386719,
            1281.23779296875, 820.9326171875, 1281.5390625, 997.651062011719,
            1281.09741210938, 1172.80249023438, 1280.76110839844, 1347.68518066406,
            1279.64233398438, 1521.85705566406, 1279.19775390625, 1695.23962402344,
            1449.93334960938, 644.048950195312, 1450.77868652344, 824.600158691406,
            1450.87243652344, 1002.43237304688, 1450.599609375, 1178.57165527344,
            1449.0771484375, 1354.24145507812, 1447.05615234375, 1529.85925292969,
            1445.30004882812, 1705.27270507812, 1625.02465820312, 646.35205078125,
            1625.01672363281, 828.458068847656, 1624.681640625, 1007.18670654297,
            1623.21923828125, 1184.17993164062, 1621.7265625, 1360.79125976562,
            1619.21801757812, 1537.80590820312, 1616.21997070312, 1715.47229003906,
            1801.09167480469, 648.604431152344, 1799.98278808594, 831.865844726562,
            1798.42456054688, 1011.67730712891, 1796.98059082031, 1189.61730957031,
            1794.65441894531, 1367.39709472656, 1792.00964355469, 1545.70581054688,
            1789.18627929688, 1724.669921875, 1981.22509765625, 650.396118164062,
            1978.71936035156, 835.037048339844, 1975.97229003906, 1016.12976074219,
            1973.50695800781, 1195.40283203125, 1971.20739746094, 1374.6728515625,
            1968.65637207031, 1554.06579589844, 1966.38220214844, 1733.94384765625,
            2163.66748046875, 651.206604003906, 2159.78100585938, 837.484558105469,
            2156.244140625, 1020.22265625, 2153.60791015625, 1201.09326171875,
            2150.75732421875, 1381.91369628906, 2148.36767578125, 1562.98706054688,
            2146.21704101562, 1744.28210449219, 2351.1767578125, 651.087646484375,
            2345.85815429688, 839.170959472656, 2341.412109375, 1024.04541015625,
            2337.7509765625, 1206.95861816406, 2335.021484375, 1389.78259277344,
            2332.39770507812, 1572.72253417969, 2330.04614257812, 1756.01049804688,
            2542.56079101562, 650.869506835938, 2536.09814453125, 840.858825683594,
            2530.69213867188, 1028.04077148438, 2526.42822265625, 1213.30078125,
            2522.783203125, 1398.21435546875, 2519.90063476562, 1582.81750488281,
            2516.88452148438, 1767.20812988281])

        d5 = np.array([ 1596.62854003906, 1016.5334472656, 1587.8056640625, 1113.32592773438,
            1578.66979980469, 1211.9173583984, 1569.09948730469, 1312.7292480468,
            1558.85461425781, 1416.2515869140, 1548.15600585938, 1522.6054687,
            1536.8037109375, 1631.78503417969, 1695.73828125, 1014.96600341797,
            1687.919921875, 1112.16101074219, 1679.75012207031, 1210.9367675781,
            1671.17553710938, 1312.0540771484, 1662.32861328125, 1416.0747070312,
            1653.04077148438, 1523.1218261718, 1643.71435546875, 1633.4870605468,
            1794.91357421875, 1013.9649047851, 1788.12329101562, 1111.4367675781,
            1781.18090820312, 1210.817382812, 1774.13696289062, 1312.4553222656,
            1766.26928710938, 1417.007812, 1758.3515625, 1524.39807128906,
            1750.19201660156, 1635.2225341796, 1896.05139160156, 1013.2653808593,
            1890.36047363281, 1111.254882812, 1884.61071777344, 1210.946289062,
            1878.53100585938, 1313.1330566406, 1872.23413085938, 1418.0330810546,
            1865.7392578125, 1525.94165039062, 1858.77697753906, 1637.2012939453,
            1997.38269042969, 1012.8605346679, 1992.73181152344, 1111.2453613281,
            1987.86730957031, 1211.4012451171, 1983.30834960938, 1313.85351562,
            1978.14685058594, 1419.3803710937, 1972.970703125, 1527.80200195312,
            1967.74670410156, 1639.7016601562, 2100.78662109375, 1012.7204589843,
            2096.88940429688, 1111.4514160156, 2093.12573242188, 1212.1000976562,
            2089.54663085938, 1315.2926025390, 2086.0927734375, 1421.26953125,
            2082.30810546875, 1530.3393554687, 2078.8125, 1643.02722167969,
            2204.65844726562, 1012.9492797851, 2202.0966796875, 1112.13696289062,
            2199.56176757812, 1213.3898925781, 2197.38525390625, 1316.9458007812,
            2195.05810546875, 1423.55273437, 2192.84448242188, 1533.3096923828,
            2190.82446289062, 1646.6356201171, 2310.72509765625, 1013.1277465820,
            2309.03344726562, 1112.6761474609, 2307.86987304688, 1214.364257812,
            2306.70874023438, 1318.627929687, 2306.03588867188, 1425.8255615234,
            2305.2001953125, 1536.51293945312, 2304.4326171875, 1650.27709960938,
            2417.62353515625, 1013.4673461914, 2417.26196289062, 1113.610351562,
            2417.1416015625, 1215.89245605469, 2417.3720703125, 1320.85864257812,
            2417.97338867188, 1428.9556884765, 2418.43334960938, 1540.1915283203,
            2419.30078125, 1654.59033203125])

        image_points = np.array([d1,d2,d3,d4,d5]).reshape(5,63,2).astype(np.float32)
        world_points = world_point[None, :].repeat(5, 0)
        image_size=(4032, 2268)
        
    else:
        image_paths = files.get_img_paths("./data/data0/")
        images = list(map(get_image, image_paths))
        image_size = images[0].shape[:2]

        image_points = list(map(get_image_point, images, [col]*len(images), [row]*len(images)))
        image_points = [image_point[1] for image_point in image_points if image_point[0] == True]
        world_points = world_point[None, :].repeat(len(image_points), 0)
        
    Hs = np.stack(list(map(compute_homography, image_points, world_points)))
    K, Kinv = compute_intrinsic(Hs)
    print(K)

    Rs = []
    ts = []
    for i, H in enumerate(Hs):
        print(f"{'='*15} image {i} {'='*15}")
        r1 = Kinv@H[:, 0]
        r2 = Kinv@H[:, 1]
        r3 = np.cross(r1, r2)
        t = (1/la.norm(r1)) * Kinv@H[:, 2]

        U,D,V = la.svd(np.column_stack([r1, r2, r3]))
        R = U@V
        print("H")
        print(H)
        print("R")
        print(R)
        print('t')
        print(t)
        Rs += [R]
        ts += [t]

    print()
    if VIS:
        from visualization import Visualizer
        vis=Visualizer(K, image_size, (col, row), 20)
        for i, (R, t) in enumerate(zip(Rs, ts)):
            vis.add_camera(R, t, i)
        vis.show()

